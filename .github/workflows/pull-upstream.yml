on:
  workflow_dispatch:
  schedule:
  - cron: '0 0 * * *'

env:
  REPO_UPSTREAM: https://github.com/gravitational/teleport.git

jobs:
  update:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true

    steps:
    - name: checkout ci
      uses: actions/checkout@v2
      with:
        ref: ci
        fetch-depth: 1
        token: ${{ secrets.GH_PAT }}

    - name: Identify LATEST
      run: |
        git ls-remote --tags ${{ env.REPO_UPSTREAM }} | awk -F '/' '!/-/ && !/\^/ && /\/v/{$0=$NF;print}' | sort -Vr | head -n 1 > LATEST
        comm -23 <(git ls-remote --tags https://github.com/${{ github.repository }} | awk -F '/' '!/\^/{$0=$NF;print}' | sort -V) <(sort -V VERSIONS) | head -n 1 >> VERSIONS
        if ! git diff-index --quiet HEAD --; then
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add LATEST VERSIONS
          git commit -m "ci: Bump LATEST($(cat LATEST)) and VERSIONS($(tail -n 1 VERSIONS))"
          git push origin ci --quiet
        fi

    - name: Identify upstream branches
      id: upstream
      run: |
        echo "::set-output name=branches::$(git ls-remote --heads https://github.com/gravitational/teleport.git | awk -F '/' '/refs\/heads\/branch/ && !/-/{$0=$NF;print}' | sort -V | tr '\n' ',')"

    - name: Sync upstream branches
      run: |
        git remote add upstream ${{ env.REPO_UPSTREAM }}
        for upstream_branch in $(echo "${{ steps.upstream.outputs.branches }}" | tr ',' '\n'); do
          own_branch=$(echo "source-v${upstream_branch/v/}")
          echo "::group::Updating branch ${own_branch}"

          git fetch upstream refs/heads/branch/${upstream_branch}:${own_branch}
          git checkout ${own_branch}

          git tag -l | grep -v "^v${upstream_branch/v/}" | xargs git tag -d
          git tag -l | awk '!/^v/ || /-/ || /\^/{print}' | xargs git tag -d

          git push origin ${own_branch}
          git push origin ${own_branch} --tags
          echo "::endgroup::"
          sleep 1s
        done
