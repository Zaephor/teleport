_build: &_build
  stage: build
  deploy:
  - provider: releases
    api_key: "$GITHUB_OAUTH_TOKEN"
    skip_cleanup: true
    "on":
      tags: true
    file_glob: true
    file: "artifacts/*"
  before_script:
  - export REMOTE_BRANCH=${TRAVIS_TAG:-master}
  - export GOOS=${BUILD_GOOS}
  - export GOARCH=${BUILD_GOARCH}
  - if [[ -n "${BUILD_GOARM}" ]]; then export GOARM=${BUILD_GOARM} ; fi
  - if [[ -n "${BUILD_CC}" ]]; then export CC=${BUILD_CC} ; fi
  - echo "GOOS ${GOOS}, GOARCH ${GOARCH}, ARCH_LABEL ${ARCH_LABEL}, REMOTE_BRANCH ${REMOTE_BRANCH}, CC ${CC}"
  - git clone -q --branch=${REMOTE_BRANCH} https://github.com/gravitational/teleport.git ${GOPATH}/src/github.com/gravitational/teleport && cd ${GOPATH}/src/github.com/gravitational/teleport && git checkout -qf ${REMOTE_BRANCH} 
  after_success:
  - bash ${TRAVIS_BUILD_DIR}/rename.sh
  - find ${TRAVIS_BUILD_DIR}/artifacts

_arm_pkgs: &_arm_pkgs
  addons:
    apt:
      update: true
      packages:
      - gcc-multilib
      - gcc-4.7-arm-linux-gnueabi
      - gcc-arm-linux-gnueabi
      - libc6-armel-cross
      - libc6-dev-armel-cross
      - libc6-armhf-armel-cross
      - libc6-dev-armhf-armel-cross

_386_pkgs: &_386_pkgs
  addons:
    apt:
      update: true
      packages:
      - gcc-multilib
      - libc6-dev-i386

language: go

go: "1.10"

services:
- docker

stages:
- name: build

jobs:
  include:
  - name: linux i386
    env:
    - BUILD_GOOS=linux
    - BUILD_GOARCH=386
    - ARCH_LABEL=i386
    script: cd ${GOPATH}/src/github.com/gravitational/teleport && make release
    <<: *_build
    <<: *_386_pkgs
  - name: linux amd64
    env:
    - BUILD_GOOS=linux
    - BUILD_GOARCH=amd64
    - ARCH_LABEL=amd64
    script: cd ${GOPATH}/src/github.com/gravitational/teleport && make release
    <<: *_build
  - name: linux armel
    env:
    - BUILD_GOOS=linux
    - BUILD_GOARCH=arm
    - BUILD_GOARM=5
    - BUILD_CC=arm-linux-gnueabi-gcc
    - ARCH_LABEL=armel
    script: cd ${GOPATH}/src/github.com/gravitational/teleport && make release
    <<: *_build
    <<: *_arm_pkgs
  - name: linux armhf
    env:
    - BUILD_GOOS=linux
    - BUILD_GOARCH=arm
    - BUILD_GOARM=6
    - BUILD_CC=arm-linux-gnueabi-gcc
    - ARCH_LABEL=armhf
    script: cd ${GOPATH}/src/github.com/gravitational/teleport && make release
    <<: *_build
    <<: *_arm_pkgs
  - name: windows i386
    env:
    - BUILD_GOOS=windows
    - BUILD_GOARCH=386
    - ARCH_LABEL=i386
    script: cd ${GOPATH}/src/github.com/gravitational/teleport && make release
    <<: *_build
  - name: windows amd64
    env:
    - BUILD_GOOS=windows
    - BUILD_GOARCH=amd64
    - ARCH_LABEL=amd64
    script: cd ${GOPATH}/src/github.com/gravitational/teleport && make release
    <<: *_build
#  - name: linux arm64
#    env:
#    - BUILD_GOOS=linux
#    - BUILD_GOARCH=arm64
#    - BUILD_CC=arm-linux-gnueabi-gcc
#    - ARCH_LABEL=arm64
#    script: cd ${GOPATH}/src/github.com/gravitational/teleport && make release
#    <<: *_build
#    <<: *_arm_pkgs
